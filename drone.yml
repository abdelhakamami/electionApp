kind: pipeline
name: build 
type: kubernetes

steps:
- name: build-backend-image
  image: plugins/docker
  settings:
    registry: docker.io
    username: 
        from_secret: docker_username
    password:
        from_secret: docker_password
    dockerfile: ./back-end/Dockerfile
    repo: abdelhakavaxia/election-app-back-end
    context: ./back-end
    tags: dev${DRONE_COMMIT_SHA:0:7}
- name: build-frontend-image
  image: plugins/docker
  settings:
    registry: docker.io
    username: 
        from_secret: docker_username
    password: 
        from_secret: docker_password
    dockerfile: ./front-end/Dockerfile
    repo: abdelhakavaxia/election-app-front-end
    context: ./front-end
    tags: dev${DRONE_COMMIT_SHA:0:7}


- name: deploy-to-kubernetes
  image: alpine/git
  settings:
    namespace: test
    server: http://20.210.13.147:80/
    token:
      from_secret: kubernetes_token
  commands:
  - mkdir -p /root/.ssh && echo "$SSH_KEY" > /root/.ssh/id_rsa && chmod 600 /root/.ssh/id_rsa && ssh-keyscan github.com >> /root/.ssh/known_hosts
  - git clone git@github.com:my-org/my-repo.git
  - cd my-repo
  - git add .
  - git commit -m "Update container image tag to ${DRONE_COMMIT_SHA}"
  - git push
#commands:
#       - cd electionApp
#       - |
#         TAG=$(git rev-parse --short HEAD)
#         kubectl kustomize . --build-arg TAG=$TAG | kubectl apply -f -
